<!doctype html>
<html lang="en" dir="ltr">
<head>
	
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	
	<title></title>
	<meta name="description" content="">
	<meta name="keywords" content="">
	
	<style>
		
		* {
			-webkit-box-sizing: border-box;
			   -moz-box-sizing: border-box;
			        box-sizing: border-box;
		}
		
		.loading {
			background: url(loader.gif) no-repeat;
			width: 25px;
			height: 25px;
			background-size: cover;
			position: absolute;
			top: 5px;
			right: 5px;
		}
		
		.data {
			position: relative;
			max-width: 300px;
			border: 1px solid #ccc;
			margin: 20px auto;
			padding: 20px;
		}
		
		.data .bar {
			background: #ccc;
			width: 0;
			height: 20px;
			border-radius: 3px;
			display: block;
			-webkit-transition: width 0.4s;
			   -moz-transition: width 0.4s;
			     -o-transition: width 0.4s;
			        transition: width 0.4s;
		}
		
	</style>
	
</head>
<body>
	
	<div id="mod1" class="data">
		<div></div>
		<span class="bar"></span>
	</div>
	
	<div id="mod2" class="data">
		<div></div>
		<span class="bar"></span>
	</div>
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script>
		
		$(document).ready(function() {
			
			var $loading = $('<span />', {
				'class': 'loading'
			});
			
			// Master JSON handler:
			
			var worker = function(options) {
				
				var $this = this;
				var $loading = $this.find('.loading');
				
				$.ajax({
					//url: options.url,
					url: ('foo' + ((Math.random() * 2 | 0) + 1) + '.json'),
					//dataType: 'jsonp',
					cache: false,
					beforeSend: function() {
						$loading.fadeIn('fast');
					},
					success: function() {
						$loading.fadeOut('fast');
					}
					
				})
					.done(function(data) {
						
						console.log('Second success!');
						
						options.callback.call($this, data);
						
						setTimeout(function() {
							worker.call($this, options)
						}, options.timeout);
						
					})
					.fail(function(data) {
						
						console.log('Error?');
						
						setTimeout(function() {
							worker.call($this, options)
						}, options.timeout);
						
					})
					.always(function(data) {
						
						console.log('Complete!');
						
					});
				
			};
			
			// Example module calls follow ...
			
			//----------------------------------------------------------------------
			
			// Append loader gif to all data divs:
			$loading
				.hide()
				.appendTo('.data');
			
			// Fire off first API call:
			worker.call($('#mod1'), {
				timeout: 10000,
				//url: ...,
				callback: function(data) {
					
					var $this = $(this);
					var json = $.parseJSON(data);
					
					//console.log(this, data, json.options[0].percent_of_state_votes);
					
					$this
						.find('div')
							.html(json.contest_wrapper);
					
					$this
						.find('.bar')
							.width(json.options[0].percent_of_state_votes + '%');
					
				}
			});
			
			//----------------------------------------------------------------------
			
			// Fire off second API call:
			worker.call($('#mod2'), {
				timeout: 5000,
				//url: ...,
				callback: function(data) {
					
					var $this = $(this);
					var json = $.parseJSON(data);
					
					//console.log(this, data, json.options[1].percent_of_state_votes);
					
					$this
						.find('div')
							.html(json.contest_wrapper);
					
					$this
						.find('.bar')
							.width(json.options[1].percent_of_state_votes + '%');
					
				}
			});
			
		});
		
	</script>
	
</body>
</html>
